
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b10" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon-180.png" />
  <title>Rifle Stock Check</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header>
    <h1>Rifle Stock Check</h1>
    <div class="sub" id="datasetInfo">Loading…</div>
  </header>

  <div class="container">
    <div id="noData" class="card" hidden>
      <div style="display:flex; gap:12px; align-items:center;">
        <img src="./icon-192.png" alt="" width="52" height="52" style="border-radius:14px; border:1px solid rgba(255,255,255,.10);" />
        <div>
          <div style="font-weight:750;">Load your rifle stock CSV</div>
          <div class="small">Default filter is <b>Condition = New</b>. You can then filter by <b>Model</b> (exact match) and start scanning.</div>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="importBtn">Import CSV</button>
        <button class="ghost" id="helpBtn" onclick="document.querySelector('#helpModal').showModal()">How to install</button>
      </div>
      <div class="footerHint">
        Tip: After opening in Safari, use <b>Share → Add to Home Screen</b> so it feels like a real app.
      </div>
    </div>

    <div id="hasData" hidden>
      <div class="card">
        <div class="row2">
          <div>
            <label for="conditionSel">Condition</label>
            <select id="conditionSel">
              <option value="New">New (default)</option>
              <option value="Used">Used</option>
              <option value="All">All</option>
            </select>
          </div>
          <div>
            <label for="modelSel">Model (exact match)</label>
            <select id="modelSel"></select>
          </div>
        </div>

        <div class="spacer"></div>
        <div class="small" id="activeFilters">—</div>

        <div class="counters">
          <div class="counter"><div class="k">Expected</div><div class="v" id="expectedVal">0</div></div>
          <div class="counter"><div class="k">Scanned</div><div class="v" id="scannedVal">0</div></div>
          <div class="counter"><div class="k">Missing</div><div class="v" id="missingVal">0</div></div>
        </div>

        <div id="quickStatus"></div>

        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="scanBtn">Scan Barcode</button>
          <button id="importBtn2" onclick="document.querySelector('#fileInput').click()">Replace CSV</button>
        </div>

        <div class="actions3">
          <button id="exportFilteredBtn">Export Filtered (with Missing)</button>
          <button id="exportAllBtn">Export All (Scanned column)</button>
          <button class="danger" id="resetBtn">Reset Check</button>
        </div>

        <div class="actions" style="margin-top:10px;">
          <button class="ghost" id="clearCsvBtn">Remove saved CSV</button>
          <button class="ghost" onclick="document.querySelector('#helpModal').showModal()">Install help</button>
        </div>

        <input id="searchBox" placeholder="Search stock number / make / model…" style="margin-top:10px;" />

        <div class="tabs">
          <button class="tab" data-tab="missing">Missing</button>
          <button class="tab" data-tab="scanned">Scanned</button>
          <button class="tab" data-tab="all">All Filtered</button>
        </div>

        <div class="list" id="list"></div>

        <div class="footerHint">
          Scans are saved on your phone. If a barcode won’t scan, use manual entry in the scanner window.
        </div>
      </div>
    </div>
  </div>

  <input id="fileInput" type="file" accept=".csv,text/csv" hidden />

  <div id="toast"></div>

  <!-- Scan modal -->
  <dialog id="scanModal">
    <div class="modal">
      <div class="modalHeader">
        <h2>Scan barcode</h2>
        <button class="ghost" id="scanClose">Close</button>
      </div>
      <div class="videoWrap">
        <video id="video" playsinline></video>
      </div>
      <div class="small" style="margin-top:10px;" id="scanStatus">—</div>
      <div class="row2" style="margin-top:10px;">
        <div>
          <label>Manual entry (fallback)</label>
          <input id="manualInput" placeholder="Type stock number…" autocomplete="off" />
        </div>
        <div style="display:flex; align-items:end;">
          <button id="manualAddBtn">Add</button>
        </div>
      </div>
      <div class="footerHint">
        If camera doesn’t open: iPhone Settings → Safari → Camera → Allow. Also ensure you opened the app in Safari.
      </div>
    </div>
  </dialog>

  <!-- Mapping modal -->
  <dialog id="mappingModal">
    <div class="modal">
      <div class="modalHeader">
        <h2>Map CSV columns</h2>
      </div>
      <div class="small">We couldn’t auto-detect your column names. Pick which columns are Stock Number, Condition and Model.</div>
      <div id="mappingBody"></div>
      <div class="actions" style="margin-top:12px;">
        <button class="primary" id="mappingSave">Save mapping</button>
        <button class="ghost" id="mappingCancel">Cancel</button>
      </div>
    </div>
  </dialog>

  <!-- Help modal -->
  <dialog id="helpModal">
    <div class="modal">
      <div class="modalHeader">
        <h2>Install on iPhone (Home Screen)</h2>
        <button class="ghost" onclick="this.closest('dialog').close()">Close</button>
      </div>
      <div class="footerHint">
        <ol>
          <li>Open this app in <b>Safari</b>.</li>
          <li>Tap <b>Share</b> (square with arrow).</li>
          <li>Tap <b>Add to Home Screen</b>.</li>
          <li>Open from the new icon — it will remember your CSV and scans.</li>
        </ol>
        <div style="margin-top:10px;">
          Note: Camera scanning works best when the app is served over <b>https</b> (or from localhost). If you’re opening straight from files, camera may be blocked. Use a simple local host (included instructions when you place on a small host).
        </div>
      </div>
    </div>
  </dialog>

  <script type="module" src="./app.js"></script>
</body>
</html>
